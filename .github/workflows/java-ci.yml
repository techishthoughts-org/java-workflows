# .github/workflows/java-ci.yml
# Purpose: Unified Java CI workflow v3.2.0 with multi-version matrix and advanced features
# Version: 3.2.0
# Java Support: 11 (LTS), 17 (LTS), 21 (LTS), 23, 24, 25 (LTS)
# New in 3.2.0: Multi-version matrix testing, enhanced caching, fail-fast control
#
# Inputs:
#   java-version: Java version to use (default: 25)
#   java-version-matrix: Test against multiple Java versions (e.g., '11,17,21,25')
#   build-tool: Build tool - 'maven', 'gradle', or 'auto' (default: 'auto')
#   os-matrix: Operating systems to test on (default: 'ubuntu-latest')
#   enable-caching: Enable dependency caching (default: true)
#   run-tests: Run tests (default: true)
#   generate-coverage: Generate coverage reports (default: true)
#   upload-artifacts: Upload build artifacts (default: true)
#   fail-fast: Fail fast in matrix (default: false)
#
# Outputs:
#   build-tool-detected: Auto-detected build tool
#   test-results: Test execution results
#   coverage-percentage: Code coverage percentage
#   build-status: Overall build status
#
# Usage:
#   jobs:
#     ci:
#       uses: org/workflows/.github/workflows/java-ci.yml@v3
#       with:
#         java-version: '25'

name: ðŸš€ Java CI v3.2.0

on:
  workflow_call:
    inputs:
      java-version:
        required: false
        type: string
        default: '25'
      java-version-matrix:
        required: false
        type: string
        default: ''
      build-tool:
        required: false
        type: string
        default: 'auto'
      os-matrix:
        required: false
        type: string
        default: 'ubuntu-latest'
      enable-caching:
        required: false
        type: boolean
        default: true
      run-tests:
        required: false
        type: boolean
        default: true
      generate-coverage:
        required: false
        type: boolean
        default: true
      upload-artifacts:
        required: false
        type: boolean
        default: true
      fail-fast:
        required: false
        type: boolean
        default: false
    outputs:
      build-tool-detected:
        description: "Auto-detected build tool"
        value: ${{ jobs.build.outputs.build-tool }}
      test-results:
        description: "Test execution results"
        value: ${{ jobs.build.outputs.test-results }}
      coverage-percentage:
        description: "Code coverage percentage"
        value: ${{ jobs.build.outputs.coverage-percentage }}
      build-status:
        description: "Overall build status"
        value: ${{ jobs.build.outputs.build-status }}

jobs:
  detect-and-build:
    name: ðŸ”¨ Build & Test (Java ${{ matrix.java }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      fail-fast: ${{ inputs.fail-fast }}
      matrix:
        os: ${{ fromJson(format('["{0}"]', inputs.os-matrix)) }}
        java: ${{ inputs.java-version-matrix != '' && fromJson(format('["{0}"]', inputs.java-version-matrix)) || fromJson(format('["{0}"]', inputs.java-version)) }}
    outputs:
      build-tool: ${{ steps.detect.outputs.build-tool }}
      test-results: ${{ steps.test.outputs.results }}
      coverage-percentage: ${{ steps.coverage.outputs.percentage }}
      build-status: ${{ steps.build-status.outputs.status }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Auto-detect build tool
        id: detect
        shell: bash
        run: |
          BUILD_TOOL="${{ inputs.build-tool }}"

          if [[ "$BUILD_TOOL" == "auto" ]]; then
            echo "ðŸ” Auto-detecting build tool..."

            if [ -f "pom.xml" ]; then
              BUILD_TOOL="maven"
              echo "âœ… Detected Maven (pom.xml found)"
            elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
              BUILD_TOOL="gradle"
              echo "âœ… Detected Gradle (build.gradle found)"
            else
              echo "âŒ Could not auto-detect build tool. Please specify build-tool input."
              exit 1
            fi
          else
            echo "ðŸ“Œ Using specified build tool: $BUILD_TOOL"
          fi

          echo "build-tool=$BUILD_TOOL" >> $GITHUB_OUTPUT

      - name: â˜• Setup Java ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: ${{ steps.detect.outputs.build-tool }}

      - name: ðŸ”¨ Build with Maven
        if: steps.detect.outputs.build-tool == 'maven'
        id: build-maven
        shell: bash
        run: |
          echo "ðŸ”¨ Building with Maven..."
          MAVEN_CMD="./mvnw"
          if [ ! -x "$MAVEN_CMD" ]; then
            MAVEN_CMD="mvn"
          fi

          "$MAVEN_CMD" clean package -DskipTests -B
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ”¨ Build with Gradle
        if: steps.detect.outputs.build-tool == 'gradle'
        id: build-gradle
        shell: bash
        run: |
          echo "ðŸ”¨ Building with Gradle..."
          if [ -x "./gradlew" ]; then
            chmod +x ./gradlew
            GRADLE_CMD="./gradlew"
          else
            GRADLE_CMD="gradle"
          fi

          "$GRADLE_CMD" clean build -x test
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ðŸ“ˆ Capture build status
        id: build-status
        shell: bash
        run: |
          STATUS="${{ steps.build-maven.outputs.status || steps.build-gradle.outputs.status || '' }}"
          if [ -z "$STATUS" ]; then
            STATUS="skipped"
          fi
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: ðŸ§ª Run Tests
        if: inputs.run-tests == true
        id: test
        shell: bash
        run: |
          BUILD_TOOL="${{ steps.detect.outputs.build-tool }}"

          echo "ðŸ§ª Running tests with $BUILD_TOOL..."

          if [[ "$BUILD_TOOL" == "maven" ]]; then
            MAVEN_CMD="./mvnw"
            if [ ! -x "$MAVEN_CMD" ]; then
              MAVEN_CMD="mvn"
            fi

            "$MAVEN_CMD" test -B
            RESULTS_PATH="target/surefire-reports"
          else
            if [ -x "./gradlew" ]; then
              chmod +x ./gradlew
              GRADLE_TEST_CMD="./gradlew"
            else
              GRADLE_TEST_CMD="gradle"
            fi

            "$GRADLE_TEST_CMD" test
            RESULTS_PATH="build/test-results/test"
          fi

          # Parse results
          TOTAL=0
          PASSED=0
          FAILED=0

          if [ -d "$RESULTS_PATH" ]; then
            for file in "$RESULTS_PATH"/*.xml; do
              if [ -f "$file" ]; then
                T=$(grep -o 'tests="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1 || echo "0")
                F=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1 || echo "0")
                E=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' | head -1 || echo "0")

                TOTAL=$((TOTAL + T))
                FAILED=$((FAILED + F + E))
              fi
            done
            PASSED=$((TOTAL - FAILED))
          fi

          RESULTS="Total: $TOTAL, Passed: $PASSED, Failed: $FAILED"
          echo "results=$RESULTS" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Test Results: $RESULTS"

      - name: ðŸ“Š Generate Coverage
        if: inputs.generate-coverage == true
        id: coverage
        shell: bash
        run: |
          BUILD_TOOL="${{ steps.detect.outputs.build-tool }}"

          echo "ðŸ“Š Generating coverage report..."

          if [[ "$BUILD_TOOL" == "maven" ]]; then
            MAVEN_CMD="./mvnw"
            if [ ! -x "$MAVEN_CMD" ]; then
              MAVEN_CMD="mvn"
            fi

            "$MAVEN_CMD" jacoco:report -B
            COVERAGE_FILE="target/site/jacoco/index.html"
          else
            if [ -x "./gradlew" ]; then
              chmod +x ./gradlew
              GRADLE_COVERAGE_CMD="./gradlew"
            else
              GRADLE_COVERAGE_CMD="gradle"
            fi

            "$GRADLE_COVERAGE_CMD" jacocoTestReport
            COVERAGE_FILE="build/reports/jacoco/test/html/index.html"
          fi

          # Simple coverage extraction
          if [ -f "$COVERAGE_FILE" ]; then
            COVERAGE=$(grep -o '[0-9]*%' "$COVERAGE_FILE" | head -1 | tr -d '%' || echo "0")
            echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "ðŸ“Š Coverage: ${COVERAGE}%"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¤ Upload Artifacts
        if: inputs.upload-artifacts == true && always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            target/*.jar
            build/libs/*.jar
          if-no-files-found: ignore
          retention-days: 7

      - name: ðŸ“ Build Summary
        if: always()
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### ðŸš€ Java CI v3.2.0 Summary

          | Metric | Value |
          |--------|-------|
          | **Java Version** | ${{ matrix.java }} |
          | **Build Tool** | ${{ steps.detect.outputs.build-tool }} (auto-detected) |
          | **OS** | ${{ matrix.os }} |
          | **Tests** | ${{ steps.test.outputs.results || 'Skipped' }} |
          | **Coverage** | ${{ steps.coverage.outputs.percentage || 'N/A' }}% |
          | **Status** | ${{ steps.build-status.outputs.status }} |

          **v3.2.0 Features:**
          - âœ… Auto-detection of build tools
          - âœ… Java 11-25 support (all LTS versions)
          - âœ… Multi-version matrix testing
          - âœ… Enhanced caching strategies
          - âœ… Fail-fast control
          - âœ… Cloud-native ready

          EOF

  build:
    name: ðŸ“Š Aggregate Results
    needs: detect-and-build
    runs-on: ubuntu-latest
    if: always()
    outputs:
      build-tool: ${{ needs.detect-and-build.outputs.build-tool }}
      test-results: ${{ needs.detect-and-build.outputs.test-results }}
      coverage-percentage: ${{ needs.detect-and-build.outputs.coverage-percentage }}
      build-status: ${{ needs.detect-and-build.outputs.build-status }}
    steps:
      - name: ðŸ“Š Summary
        run: |
          echo "âœ… Java CI v3.2.0 completed successfully"
          echo "Build Tool: ${{ needs.detect-and-build.outputs.build-tool }}"
